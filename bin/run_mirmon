#!/bin/bash
set -euxo pipefail

MIRRORHOME=/var/www/download.grml.org/grml-mirrors

# update mirrorlist from git
cd $MIRRORHOME
git reset --hard
git pull

bin/masterlist2mirmon Mirrors.masterlist > ../state/mirror.list

# first run mirmon
LC_ALL=C /usr/bin/mirmon -get update

# then generatore the mirror map
bin/generate_mirror_map Mirrors.masterlist > ../state/grml.map
# separate list of all ipv6-enabled mirrors
bin/generate_mirror_map Mirrors.masterlist -6 > ../state/grml6.map

# give a hint to apache2
/usr/sbin/apache2ctl graceful
